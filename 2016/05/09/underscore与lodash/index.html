<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>underscore与lodash | k&#39;s Arable Land</title>
  <meta name="author" content="k">
  
  <meta name="description" content="discover more">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="underscore与lodash"/>
  <meta property="og:site_name" content="k&#39;s Arable Land"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="k&#39;s Arable Land" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="headerwrap">
  <div class="alignleft title rotate">
    <h1><a href="/">k&#39;s Arable Land</a></h1>
    <h2><a href="/">discover more</a></h2>
  </div>
  <nav id="main-nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/demo/360/imageviewer">Demo</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-05-09T14:34:59.000Z"><a href="/2016/05/09/underscore与lodash/">2016-05-09</a></time>
      
      
  
    <h1 class="title">underscore与lodash</h1>
  

    </header>
    <div class="entry">
      
        <h1 id="underscore_和_lodash">underscore 和 lodash</h1><blockquote>
<p>你一定是那类能将事情做好的[人士]。但为了将事情做好，首先你得喜欢做这件事，而不是喜欢这件事情的结果，那仅仅是第二位。</p>
<ul>
<li>安 兰德</li>
</ul>
</blockquote>
<p><code>Javascript</code>是种实用的工具型语言，由于自身简洁的API及松散的类型系统，其在不少地方都有应用。<code>Javascript</code>表面看起来规模很小，故此它是种容易学习和掌握的语言。借助其这种特性可以很好的提升工作效率，但同样令人遗憾的的是，这也意味着<code>Javascript</code>的类型历史性的就缺乏那些能增强语言健壮性的高级特性，比如函数的迭代自然而然的构成了<code>集合</code>以及<code>哈希</code>的天然特性。</p>
<p> 为了弥合这种差距，<code>Jeremy Ashkenas</code>于2009年建立了<code>Underscore</code>这样一个库：一个涵盖了超过100种用来操作、过滤、哈希变换与集合的函数集。这其中的很多函数诸如 <code>map()</code>和<code>reduce()</code>之类, 都体现着与函数式编程语言所共有的概念。其他函数像<code>isArguments()</code>、<code>isUndefined()</code>则只特定于<code>Javascript</code>。</p>
<p>随着<code>Undersore</code>在许多web应用程序中的广泛应用, 发生了两件激动人心的事。第一，<code>ECMAscript 5</code>标准于同年发布了，原生<code>Javascript</code>对象中包含许多类似<code>Underscore</code>的方法，例如<code>Array.prototype.map()</code>、<code>Array.prototype.reduce()</code>和<code>Array.isArray()</code>，成为了<code>ECMAscript 5</code>特色。但尽管<code>ECMAscript 5</code>(以及对于<code>ECMAscript 6 和 7</code>中较少部分)扩展了<code>Underscore</code>的一些关键的API，它仍然仅包含<code>Underscore.js</code>的一小部分功能。</p>
<p>第二，<code>Underscore</code>被<code>fork</code>为一个叫做<code>Lodash</code>的新项目，用于显著提升其性能及扩展api。由于<code>Lodash</code>不但实现了<code>Underscore</code>中所有函数，又同时增加了其本身特有函数，故<code>Underscore</code>是<code>Lodash</code>的子集。所有相应ecmascript标准函数亦是lodash的一部分。表<code>16-1</code>表示了<code>Underscore</code>和<code>Lodash</code>与相应原生<code>ECMAscript</code>间的映射。</p>
<ul>
<li><strong>表16-1.</strong> <em>Underscore和Lodash与目前（及提案）原生Javascript对比</em></li>
</ul>
<table>
<thead>
<tr>
<th>ECMAScript 5</th>
<th style="text-align:center">Underscore/Lodash</th>
</tr>
</thead>
<tbody>
<tr>
<td>Array.prototype.every()</td>
<td style="text-align:center">all()/every()</td>
</tr>
<tr>
<td>Array.prototype.filter()</td>
<td style="text-align:center">select()/filter()</td>
</tr>
<tr>
<td>Array.prototype.forEach</td>
<td style="text-align:center">each()/forEach()</td>
</tr>
<tr>
<td>Array.isArray()</td>
<td style="text-align:center">isArray()</td>
</tr>
<tr>
<td>Object.keys()</td>
<td style="text-align:center">keys()</td>
</tr>
<tr>
<td>Array.prototype.map()</td>
<td style="text-align:center">map()</td>
</tr>
<tr>
<td>Array.prototype.reduce()</td>
<td style="text-align:center">inject()/foldl()/reduce()</td>
</tr>
<tr>
<td>Array.prototype.reduceRight()</td>
<td style="text-align:center">foldr()/reduceRight()</td>
</tr>
<tr>
<td>Array.prototype.some()</td>
<td style="text-align:center">some()</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>ECMAScript 6</th>
<th style="text-align:center">Underscore/Lodash</th>
</tr>
</thead>
<tbody>
<tr>
<td>Array.prototype.find()</td>
<td style="text-align:center">find()</td>
</tr>
<tr>
<td>Array.prototype.findIndex()</td>
<td style="text-align:center">findIndex()</td>
</tr>
<tr>
<td>Array.prototype.keys()</td>
<td style="text-align:center">keys()</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>ECMAScript 7</th>
<th style="text-align:center">Underscore/Lodash</th>
</tr>
</thead>
<tbody>
<tr>
<td>Array.prototype.contains()</td>
<td style="text-align:center">include()/contains()</td>
</tr>
</tbody>
</table>
<p>由于<code>Underscore</code>和<code>Lodash</code>共享同一套api, <code>Lodash</code>可以用作<code>Underscore</code>的替代, 但由于<code>Lodash</code>的额外功能，反过来则不一定必要。比如<code>Underscore</code>和<code>Lodash</code>都具有一个<code>clone()</code>方法，却只是<code>Lodash</code>实现了deepClone()方法。开发者选择<code>Lodash</code>多于<code>Underscore</code>通常是因为这些额外函数，此外其性能受益亦很明显。通过函数间标准性能检查程序，<code>Lodash</code>比<code>Underscore</code>平均要快上35%, 通过对类似<code>forEach()</code>、<code>map()</code>、<code>reduce()</code>等函数偏爱使用简单循环而不是函数代理，其实现了明显的性能提升。</p>
<p>本章集中于<code>Lodash</code>和<code>Underscore</code>中还没被<code>Ecmascript</code>实现（或提案）的大部分特性（见表6-11及6-12中的函数）。Mozilla出色的文档涵盖了每个原生函数，同样，<code>Underscore</code>和<code>Lodash</code>的文档中也涵盖了其每个函数的实现。</p>
<p>不仅如此，对与面向对象与集合的函数<code>Underscore</code>和<code>Lodash</code>提供的非常多，而不只是提供几个常用函数。本章将探索其中的部分函数。</p>
<blockquote>
<p>简明说来，本章的剩余部分仅仅引用了<code>Underscore</code>, 但请理解这点，除非特殊说明，<code>Underscore</code>和<code>Lodash</code>是可互换的。</p>
</blockquote>
<h2 id="安装及用法">安装及用法</h2><p>在浏览器或任何服务器端Javascript环境（例如nodejs）中， <code>Underscore</code>均可以直接作为库来导入，不需要外部依赖。</p>
<p>您可直接从<code>Underscore</code>官网下载underscore.js文件<a href="http://underscorejs.org" target="_blank" rel="external">http://underscorejs.org</a>，或者通过类似<code>Npm</code>,<code>Bower</code>,<code>Component</code>的包管理器来安装它。</p>
<p>您可以将<code>Underscore</code>作为一个<code>script</code>资源直接引入，或者通过实现了<code>AMD</code>或<code>CommonJS</code>的模块加载器（例如<code>RequireJS</code>或<code>Browserify</code>），在nodejs中包则只需简单的作为一个<code>CommonJS</code>模块引入。</p>
<p>访问<code>Underscore</code>对象（其工具函数所附属的对象）的方式依赖于函数库是如何加载的。当<code>Underscore</code>通过浏览器的<code>script</code>标签所加载，库就把自己附属在<code>window._</code>上。如清单16-1所示，对那些在一般环境下通过模块加载起创建的变量，则可很方便的把当前的underscore模块赋值给字符<code>_</code>。</p>
<p><strong>清单 16-1.</strong> 从<code>Node.js</code>模块中加载<code>Underscore</code>库</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// example-001/index.js</span></span><br><span class="line"><span class="pi">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'underscroe'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(_.VERSION);</span><br><span class="line"><span class="comment">// 1.8.2</span></span><br></pre></td></tr></table></figure>
<p>所有underscore函数都挂在_（“下划线”）对象上。由于underscore是一个工具库，他没有任何状态除了少部分状态，所有函数都是<em>幂等</em>的,即对任意函数多次传递同一个值，每次返回的结果都是相同的。只要underscore加载了，它就能立即被使用。</p>
<p>underscore函数操作多以集合（数组和类数组对象，比如argument），对象字面量及函数为主。underscore在过滤和数据变换上最为通用。许多underscore函数间是相互实现的，其互相作用在一起亦能形成强有力的的结合。</p>
<h2 id="聚合和索引">聚合和索引</h2><p>集合中的数据经常共享类似结构, 然而这些数据也会有标识属性来使它们每个都唯一。在一个数据集合中，区分这两类关系—共性和个性—是十分有用的, 为了迅速的的过滤、使用满足匹配聚合条件的对象子集。</p>
<p>underscore具有若干方法来执行这类任务， 但对处理集合来说，有三个函数则能发挥极大的作用：即countBy(),groupBy(),indexBy()。</p>
<h3 id="countBy()">countBy()</h3><p>对共享一类特征的对象进行计数是归纳数据的常用方式。对一个URL集合，可以设想若干分析过程来判定多少URL属于特定的顶级域名（例如.com, .org, .edu, .etc)。对于这个任务，<code>Underscore</code>的countBy()函数可以说是个理想的选择。它会为数组中的每个元素调用一个回调函数来决定该元素符合哪个类别（本例中即URL属于哪个顶层域名）。回调函数返回了代表该类别的字符串值。最终结果是一个对象，该对象的键代表由回调函数返回的所有类别，而代表每个元素的计数值则纳入每个类别。清单16-2展示了这样一个原生实现，其返回了一个带有两个.org域名的计数和一个.com域名的计数的对象。</p>
<p><strong>清单 16-2 按某条件对元素计数</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// example-002/index.js</span></span><br><span class="line"><span class="pi">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'underscore'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> urls = [</span><br><span class="line">	<span class="string">'http://underscorejs.org'</span>,</span><br><span class="line">	<span class="string">'http://lodash.com'</span>,</span><br><span class="line">	<span class="string">'http://ecmascript.org'</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counts = _.countBy(url, <span class="function"><span class="keyword">function</span> <span class="title">byTLD</span><span class="params">(url)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (url.indexOf(<span class="string">'.com'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'.com'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (url.indexOf(<span class="string">'org'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'.org'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">'?'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(count);</span><br><span class="line"><span class="comment">// &#123; '.org': 2, '.com': 1 &#125;</span></span><br></pre></td></tr></table></figure>
<p>若数据集合中的项为具有某些属性的对象，且该对象某个属性对应的值作为用来计数的数据，那么迭代器函数就是不必要的了，取而代之可将要被检测的属性名作参数。在清单16-3中，最终结果的键即是每个对象中被检测的属性。</p>
<p><strong>清单 16-3. 按某属性对元素计数</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//example-003/index.js</span></span><br><span class="line"><span class="pi">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'underscore'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> urls = [</span><br><span class="line">	&#123;scheme: <span class="string">'http'</span>, host: <span class="string">'underscore.js'</span>, domain: <span class="string">'.org'</span>&#125;,</span><br><span class="line">	&#123;scheme: <span class="string">'http'</span>, host: <span class="string">'lodash'</span>, domain: <span class="string">'.com'</span>&#125;,</span><br><span class="line">	&#123;scheme: <span class="string">'http'</span>, host: <span class="string">'ecmascript'</span>, domain: <span class="string">'.org'</span>&#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counts = _.countBy(urls, <span class="string">'domain'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(counts);</span><br><span class="line"><span class="comment">// &#123;'.org': 2, '.com': 1&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>若该集合中缺少要被测试的属性对象有一个或多个，那么最终结果对象就会包含一个为<code>undefined</code>的键，与之对应的值为这些对象的数目。</p>
<h3 id="groupBy()">groupBy()</h3><p><code>Underscore</code>的groupBy()函数与countBy()相似，但不同于把结果归纳为数字形式的计数，groupBy()在结果对象中把元素放入分类后的集合内。清单16-4中的URL对象都被放在了每个与之对应的顶级域名集合中。</p>
<p><strong>清单16-4 按某属性为元素分组</strong><br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// example-<span class="number">004</span>/index.js</span><br><span class="line"><span class="string">'use strict'</span></span><br><span class="line">var <span class="number">_</span> = <span class="literal">require</span>(<span class="string">'underscore'</span>);</span><br><span class="line"></span><br><span class="line">var urls = [</span><br><span class="line">	<span class="keyword">&#123;</span>scheme: <span class="string">'http'</span>, <span class="keyword">host</span>: <span class="string">'underscorejs'</span>, <span class="built_in">domain</span>: <span class="string">'.org'</span><span class="keyword">&#125;</span>,</span><br><span class="line">	<span class="keyword">&#123;</span>scheme: <span class="string">'http'</span>, <span class="keyword">host</span>: <span class="string">'lodash'</span>, <span class="built_in">domain</span>: <span class="string">'.com'</span><span class="keyword">&#125;</span>,</span><br><span class="line">	<span class="keyword">&#123;</span>scheme: <span class="string">'http'</span>, <span class="keyword">host</span>: <span class="string">'ecmascript'</span>, <span class="built_in">domain</span>: <span class="string">'.org'</span><span class="keyword">&#125;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">var counts = <span class="number">_</span>.groupBy(urls, <span class="string">'domain'</span>);</span><br><span class="line"></span><br><span class="line">console.log(groupd);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"><span class="keyword">&#123;</span></span><br><span class="line">	<span class="string">'.org'</span>: [</span><br><span class="line">		<span class="keyword">&#123;</span> scheme: <span class="string">'http'</span>, <span class="keyword">host</span>: <span class="string">'underscorejs'</span>, <span class="built_in">domain</span>: <span class="string">'.org'</span> <span class="keyword">&#125;</span>,</span><br><span class="line">		<span class="keyword">&#123;</span> scheme: <span class="string">'http'</span>, <span class="keyword">host</span>: <span class="string">'ecmascript'</span>, <span class="built_in">domain</span>: <span class="string">'.org'</span> <span class="keyword">&#125;</span>,</span><br><span class="line">	],</span><br><span class="line">	<span class="string">'.com'</span>: [</span><br><span class="line">		<span class="keyword">&#123;</span> scheme: <span class="string">'http'</span>, <span class="keyword">host</span>: <span class="string">'lodash'</span>, <span class="built_in">domain</span>: <span class="string">'.com&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意         在为元素分类时，若需要更大程度的操作，groupBy()函数第二个参数也可换成迭代器函数（把属性名参数换掉）。</p>
</blockquote>
<p>值得注意的是，只需要通过简单的查询分组后对象中每个分组数组的长度，数量值就能很容易的推导出来。在依赖于应用程序上下文时，相对于使用计数函数，优先选择分组函数会更有利。在表16-5中，可以看到,其不但展示了一个通过groupBy()的计数结果建立对象的函数，也展示了如何从分组后的数据获取的单一集合的计数值。</p>

      
    </div>
    <footer>
      
        
        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">

  <h1 class="title">留言</h1>



  

   <!-- 多说评论框 start -->
  <div class="ds-thread" ></div>
<!--data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址" 多说评论框 end -->


<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"kyhwsk"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->

  
</section>



</div></div>
    <aside id="sidebar" class="alignright">
      <div id="totop" style="position:absolute;bottom:-50px; cursor: pointer;">
        <a title="返回顶部"><img src="/imgs/scrollup.png"/></a>
      </div>
      
  

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/Performance/">Performance</a><small>2</small></li>
  
    <li><a href="/tags/css/">css</a><small>7</small></li>
  
    <li><a href="/tags/demo/">demo</a><small>1</small></li>
  
    <li><a href="/tags/engineering/">engineering</a><small>1</small></li>
  
    <li><a href="/tags/git/">git</a><small>1</small></li>
  
    <li><a href="/tags/homework/">homework</a><small>1</small></li>
  
    <li><a href="/tags/js/">js</a><small>4</small></li>
  
    <li><a href="/tags/other/">other</a><small>2</small></li>
  
    <li><a href="/tags/react-native/">react native</a><small>1</small></li>
  
    <li><a href="/tags/reactjs/">reactjs</a><small>2</small></li>
  
    <li><a href="/tags/regexp/">regexp</a><small>1</small></li>
  
    <li><a href="/tags/syntax/">syntax</a><small>2</small></li>
  
  </ul>
</div>


  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:fordawn.in">
  </form>
</div>

    </aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 k
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<script type="text/javascript">
(function($) { 
  // When to show the scroll link
  // higher number = scroll link appears further down the page   
  
  var upperLimit = 1000;
  var rotateLimit = 105 * 2;

  var $rotate = $('.rotate');
  var $headerwrap =  $('.headerwrap');

  var width = $headerwrap.outerWidth();
  var height = $headerwrap.outerHeight();
  var position = $headerwrap.position();

  $headerwrap.css({position: 'fixed', top: position.top, left: position.left, zIndex: -1, width: width + 'px', height: height + 'px'});
  $('#content').css({marginTop: '150px'});

  var $sidebar =  $('#sidebar');
  var sidepos = $sidebar.position();
  $sidebar.css({position: 'fixed', top: sidepos.top, left: sidepos.left});


  // Our scroll link element
  var scrollElem = $('#totop');
  
  // Scroll to top speed
  var scrollSpeed = 500;
  var delta = 0;
  // Show and hide the scroll to top link based on scroll position   
  scrollElem.hide();
  $(window).scroll(function () {
    var scrollTop = $(document).scrollTop();       
    if ( scrollTop > upperLimit ) {
      $(scrollElem).stop().fadeTo(300, 1); // fade back in           
    }else{
      $(scrollElem).stop().fadeTo(300, 0); // fade out
      if (scrollTop <  rotateLimit) {       
        $rotate.css({transform: 'rotateY(' + Math.min(scrollTop / 2, rotateLimit) + 'deg) translateX(' + Math.max(-scrollTop / 20, -rotateLimit) + 'em)',
        });
      }
    }
  });

  // Scroll to top animation on click
  $(scrollElem).click(function(){
    $('html, body').animate({scrollTop:0}, scrollSpeed); return false;
  });
})(jQuery);
</script>

</body>
</html>